---
title: 'Exercise #2'
author: "Raffaello Lastrico"
date: "date of submission"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# more internal settings can go here
# Consider help pages like:
# https://rmarkdown.rstudio.com/lesson-1.html
# https://www.rstudio.com/wp-content/uploads/2015/03/rmarkdown-reference.pdf

```

### Data
Analysis based on this timeseries:
<https://github.com/data-hydenv/data/blob/master/hobo/2022/10_minute/10347366.csv>

### Loaded packages
tidyverse, lubridate, zoo, readr

```{r libraries, include=FALSE}
library(tidyverse)
library(lubridate)
library(zoo)
library(readr)
```

### Preprocessing / R functions

```{r preprocessing_or_functions, message=FALSE, warning=FALSE}
# If data preprocessing is needed, do it here.
# If you have specific functions, placed them here.
# If this code chunk is not needed, delete it.

```

## 1. Quality control procedures (4 QCPs)

```{r, eval = TRUE, message=F}
# Load data from Github
data <- read_csv(file = "https://raw.githubusercontent.com/data-hydenv/data/master/hobo/2022/10_minute/10347366.csv")
head(data)
```

### 1.1 Measurement range (Plausible values)

**HOBO Specifications:**
Temperature: -20° to 70° C  -  Light intensity: 0 to 320000 lux

```{r qcp1, eval = TRUE}
# Flag values outside the ranges with 1, those within with 0 
data <- data %>% 
  mutate(QCP1 = case_when(temp <= 70 & temp >= -20 & lux <= 320000 & lux >= 0 ~ 0,
                          TRUE ~ 1)
        )

sum(data$QCP1)

```

**Question**: How many data points are outside the measurement range?

**Answer**: There are 0 data points outside the measurement range of both temperature and light intensity.

### 1.2 Plausible rate of change

```{r qcp2, eval=T}
# Calculate diference in temperature und flag those > 1° C
data <- data %>% 
  #head() %>% 
  mutate(var1 = temp - lag(x = temp), 
         QCP2 = if_else(abs(var1) > 1, true = 1, false = 0)
         ) %>% 
  select(-var1)

# Summarise time and count information for QCP2 classification
data %>% 
  mutate(daytime = strftime(dttm, format="%H:%M:%S")) %>% 
  group_by(QCP2) %>% 
  summarise(minTime = min(daytime), maxTime = max(daytime), count = length(daytime))
```

**Question**: Describe shortly how many data points failed during this QCP and discuss whether there is a certain daytime pattern of failure or not?

**Answer**: 232 data points failed this quality criterion. 3799 passed. 1 value was assigned NA, due to it being the first point. The measurements that failed all occurred between 7 am and 6:10 pm. This might suggest that larger temperature increases or drops are influenced by sunlight. 

### 1.3 Minimum variability (Persistence)

```{r qcp3}
# code for qcp3 here
data <- data %>%
  mutate(QCP3 = case_when(temp == lag(temp, n = 1) & temp == lag(temp, n = 2) & 
                          temp == lag(temp, n = 3) & temp == lag(temp, n = 4) &
                          temp == lag(temp, n = 5) ~ 1,
                          TRUE ~ 0)
        )

sum(data$QCP3, na.rm = T)

# Question: with this solution the first values of the series are not marked NA in QCP3. Is that a problem? 
```

**Task**: Code in this section should analyse the persistence.

*Results:* The time series contains 47 periods of continuos 10 minute intervals with the same value.

### 1.4 Light intensity

```{r qcp4}
# classify data points by light intensity
data <- data %>% 
  mutate(SIC = case_when(
                lux >= 0 & lux <= 10 ~ "night",
                lux >= 10 & lux <= 500 ~ "sunrise_sunset",
                lux >= 500 & lux <= 2000 ~ "overcast_full",
                lux >= 2000 & lux <= 15000 ~ "overcast_light",
                lux >= 15000 & lux <= 20000 ~ "clear_sky",
                lux >= 20000 & lux <= 50000 ~ "sunshine",
                lux >= 50000 ~ "sunshine_bright",
                TRUE ~ "NA"
               )
         ) %>% 
  relocate(SIC, .after = lux)

# 
data %>% count(SIC)

```

**Task**: Discuss shortly how often and when during daytime the QCP4 flags bad data. Elaborate on some reasons for your results.

**Answer**:

## 2. Synthesis

```{r synthesis}
# code for synthesis here
```

**Task**: Present a table or graph to show how many data points fail during the four specific QCPs. Discuss shortly the reasons for failure and compare the different QCPs against each other.

**Answer**:

## 3. Results

### 3.1 Result (Flagging system: 10-minutes-values)

```{r res1}
# code for results here
```

**Task**: At the end of the code section above you should generate one! tibble or data.frame named `qc_df` with all time information, all data points (temperature and lux) and your outcomes of the different QCPs.

### 3.2 Result (Aggregate to hourly series)

```{r res2}
# code for results here
```

**Task**: At the end of the code section above you should generate one! tibble or data.frame named `hobo_hourly` with averaged temperature values per hour or NA values (if the hour is flagged as bad data). See exercise description for more details.

-   First column: YYYY-DD-MM HH:MM:SS

-   Second column: Temperature values (4 digits), NA values possible
